import{n as Y,u as ee,r as l,o as ae,d as u,y as g,j as e,b as j,a as d,A as b,Q as c,l as se,k as L,z as te,p as re,t as oe,v as ne,x as le}from"./index-YcD-ttPr.js";import{C as ie}from"./ConfirmationModal-B558a7Nf.js";import{A as ce}from"./arrow-left-DWrRPwP3.js";import{X as T}from"./x-LSnkibjN.js";import{P as de}from"./paperclip-MXNuR3kA.js";import{c as _}from"./createLucideIcon-2-TjKtBl.js";import{C as q}from"./check-circle-CmV0t6ZD.js";import{A as V,a as me,C as ue}from"./clock-Bcthnze7.js";import{U as xe}from"./user-BwjBpHtT.js";import{F as pe}from"./file-text-B1HQ7e82.js";import{E as ge}from"./eye-IzKuIzNX.js";import{D as he}from"./download-D-WHumn4.js";import"./alert-triangle--JnSiDDj.js";/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const C=_("Lock",[["rect",{width:"18",height:"11",x:"3",y:"11",rx:"2",ry:"2",key:"1w4ew1"}],["path",{d:"M7 11V7a5 5 0 0 1 10 0v4",key:"fwvmzm"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fe=_("Send",[["path",{d:"m22 2-7 20-4-9-9-4Z",key:"1q3vgg"}],["path",{d:"M22 2 11 13",key:"nzbqef"}]]),be=n=>{if(!n)return"-";try{const[h,s,S]=n.split("-");return`${S}/${s}/${h}`}catch{return n}};function Oe(){const{id:n}=Y(),h=ee(),[s,S]=l.useState(null),[B,$]=l.useState(!0),[D,H]=l.useState([]),[v,I]=l.useState(""),[x,R]=l.useState([]),[A,O]=l.useState(!1),z=l.useRef(null),E=l.useRef(null),[w,K]=l.useState(!1),[ye,Q]=l.useState(!1),[N,W]=l.useState(!1),[U,F]=l.useState(null),[f,m]=l.useState({isOpen:!1,title:"",message:"",onConfirm:()=>{},variant:"danger"});l.useEffect(()=>{(async()=>{try{const o=(await se(L(d,"usuarios"))).docs.map(i=>({id:i.id,...i.data()}));H(o)}catch(r){console.error("Error loading users:",r)}})();const t=ae(u(d,"chamados",n),r=>{if(r.exists()){const o=r.data();S({id:r.id,...o}),K(!!o.responsavelAlterado),Q(!!o.statusAlterado),W(!!o.tipoAlterado),$(!1)}else c.error("Chamado não encontrado."),h("/chamados")},r=>{console.error("Error fetching ticket:",r),c.error("Erro ao carregar chamado."),$(!1)});return()=>t()},[n,h]),l.useEffect(()=>{if((s==null?void 0:s.status)==="Aberto"&&(s!=null&&s.dataAbertura)){const a=new Date(s.dataAbertura);(new Date-a)/(1e3*60*60)>24&&g(u(d,"chamados",n),{status:"Pendente"})}},[s,n]),l.useEffect(()=>{var a;(a=E.current)==null||a.scrollIntoView({behavior:"smooth"})},[s==null?void 0:s.interacoes]);const p=()=>{if(!j.currentUser)return"Usuário";const a=D.find(t=>t.email===j.currentUser.email);return(a==null?void 0:a.nome)||j.currentUser.displayName||j.currentUser.email||"Usuário"},X=async a=>{const t=a.target.value,r=D.find(i=>i.nome===t);if(!r)return;const o=r.nome;m({isOpen:!0,title:"Atribuir Responsável?",message:`Confirma a atribuição deste chamado para ${o}? Esta ação não poderá ser desfeita.`,variant:"info",onConfirm:async()=>{try{const i={autor:"Sistema",mensagem:`Responsável alterado para ${o} por ${p()}`,data:new Date().toISOString()};await g(u(d,"chamados",n),{responsavel:o,responsavelAlterado:!0,dataAtualizacao:new Date().toISOString(),interacoes:b(i)}),await te(L(d,"notificacoes"),{para:o,mensagem:`Você foi atribuído ao chamado ${s.codigo}`,lido:!1,data:new Date().toISOString(),link:`/chamados/${n}`}),c.success(`Responsável atribuído: ${o}`),m(y=>({...y,isOpen:!1}))}catch(i){console.error("Error updating responsible:",i),c.error("Erro ao atribuir responsável.")}}})},Z=a=>{a.target.files&&R([...x,...Array.from(a.target.files)])},G=a=>{R(x.filter((t,r)=>r!==a))},M=async a=>{if(a.preventDefault(),!(!v.trim()&&x.length===0||A)){O(!0);try{const t=[];for(const o of x){const i=re(oe,`chamados/${n}/${Date.now()}_${o.name}`),y=await ne(i,o),k=await le(y.ref);t.push({nome:o.name,url:k,tipo:o.type})}const r={autor:p(),mensagem:v,data:new Date().toISOString(),anexos:t};await g(u(d,"chamados",n),{interacoes:b(r),dataAtualizacao:new Date().toISOString(),...s.status==="Aberto"?{status:"Pendente"}:{}}),I(""),R([]),c.success("Mensagem enviada!")}catch(t){console.error("Error sending message:",t),c.error("Erro ao enviar mensagem.")}finally{O(!1)}}},J=a=>{switch(a){case"Aberto":return"bg-blue-100 text-blue-800";case"Pendente":return"bg-yellow-100 text-yellow-800";case"Revisão":return"bg-purple-100 text-purple-800";case"Fechado":return"bg-green-100 text-green-800";default:return"bg-gray-100 text-gray-800"}};if(B)return e.jsx("div",{className:"p-10 text-center",children:"Carregando detalhes..."});if(!s)return null;const P=({anexo:a,compact:t=!1})=>{var o;const r=((o=a.tipo)==null?void 0:o.startsWith("image/"))||a.nome.match(/\.(jpg|jpeg|png|gif|webp)$/i);return e.jsxs("div",{className:`flex items-center justify-between gap-2 bg-gray-50 border border-gray-200 px-3 py-2 rounded-lg transition-colors group ${t?"text-xs":"text-sm"}`,children:[e.jsxs("div",{className:"flex items-center gap-2 overflow-hidden",children:[e.jsx(pe,{className:`text-gray-400 group-hover:text-blue-500 transition-colors ${t?"w-3 h-3":"w-4 h-4"}`}),e.jsx("span",{className:"text-gray-700 truncate max-w-[150px]",children:a.nome})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:i=>{i.preventDefault(),r?F(a.url):window.open(a.url,"_blank")},className:"p-1 text-gray-500 hover:text-blue-600 hover:bg-blue-50 rounded transition-colors",title:"Visualização Rápida",children:e.jsx(ge,{className:t?"w-3 h-3":"w-4 h-4"})}),e.jsx("a",{href:a.url,target:"_blank",rel:"noopener noreferrer",className:"p-1 text-gray-500 hover:text-green-600 hover:bg-green-50 rounded transition-colors",title:"Download / Abrir Original",children:e.jsx(he,{className:t?"w-3 h-3":"w-4 h-4"})})]})]})};return e.jsxs("div",{className:"max-w-6xl mx-auto flex flex-col gap-4 pb-4",children:[e.jsxs("div",{className:"flex items-center gap-4 px-1",children:[e.jsx("button",{onClick:()=>h("/chamados"),className:"p-2 hover:bg-gray-100 rounded-full transition-colors",children:e.jsx(ce,{className:"w-6 h-6 text-gray-600"})}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-800",children:s.codigo}),e.jsx("span",{className:`px-3 py-1 rounded-full text-sm font-bold ${J(s.status)}`,children:s.status})]}),e.jsx("p",{className:"text-gray-500 text-sm mt-1",children:s.tipo})]})]}),e.jsxs("div",{className:"flex flex-col lg:flex-row gap-6 flex-1 min-h-0",children:[e.jsxs("div",{className:"flex-1 bg-white rounded-xl shadow-sm border border-gray-200 flex flex-col min-h-0 overflow-hidden",children:[e.jsxs("div",{className:"p-4 border-b border-gray-100 bg-gray-50/30",children:[s.assunto&&e.jsxs("div",{className:"mb-3 pb-3 border-b border-gray-100",children:[e.jsx("p",{className:"text-xs text-gray-400 uppercase font-bold mb-1",children:"Assunto"}),e.jsx("h2",{className:"text-lg font-bold text-gray-800 leading-snug",children:s.assunto})]}),e.jsx("p",{className:"text-xs text-gray-400 uppercase font-bold mb-1",children:"Descrição do Problema"}),e.jsx("p",{className:"text-gray-700 text-sm whitespace-pre-wrap leading-relaxed",children:s.descricao})]}),e.jsxs("div",{className:"flex-1 p-4 space-y-4 bg-gray-50/50",children:[s.interacoes&&s.interacoes.map((a,t)=>{var i;const r=p(),o=a.autor===r||a.autor===((i=j.currentUser)==null?void 0:i.email);return e.jsx("div",{className:`flex flex-col ${a.autor==="Sistema"?"items-center my-4":o?"items-end":"items-start"}`,children:a.autor==="Sistema"?e.jsx("div",{className:"bg-gray-200 text-gray-600 px-4 py-1 rounded-full text-xs font-bold uppercase tracking-wider shadow-sm",children:a.mensagem}):e.jsxs("div",{className:`max-w-[80%] ${o?"bg-blue-600 text-white rounded-l-xl rounded-tr-xl":"bg-white border border-gray-200 text-gray-800 rounded-r-xl rounded-tl-xl"} p-4 shadow-sm`,children:[e.jsxs("div",{className:"flex justify-between items-center gap-4 mb-1 opacity-80 text-xs",children:[e.jsx("span",{className:"font-bold",children:a.autor}),e.jsx("span",{children:new Date(a.data).toLocaleString("pt-BR")})]}),e.jsx("p",{className:"whitespace-pre-wrap leading-relaxed",children:a.mensagem}),a.anexos&&a.anexos.length>0&&e.jsx("div",{className:"mt-3 space-y-2",children:a.anexos.map((y,k)=>e.jsx(P,{anexo:y},k))})]})},t)}),e.jsx("div",{ref:E})]}),e.jsxs("div",{className:"p-4 bg-white border-t border-gray-200",children:[x.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2 mb-3",children:x.map((a,t)=>e.jsxs("div",{className:"flex items-center gap-2 bg-blue-50 text-blue-700 px-3 py-1 rounded-full text-sm border border-blue-100",children:[e.jsx("span",{className:"max-w-[150px] truncate",children:a.name}),e.jsx("button",{onClick:()=>G(t),className:"hover:text-blue-900",children:e.jsx(T,{className:"w-4 h-4"})})]},t))}),e.jsxs("form",{onSubmit:M,className:"flex gap-2 items-end",children:[e.jsx("button",{type:"button",onClick:()=>{var a;return(a=z.current)==null?void 0:a.click()},className:"p-3 text-gray-500 hover:bg-gray-100 rounded-xl transition-colors disabled:opacity-50 disabled:cursor-not-allowed",title:"Anexar arquivo",disabled:s.status==="Fechado"&&s.jaFoiRevisado,children:e.jsx(de,{className:"w-5 h-5"})}),e.jsx("input",{type:"file",ref:z,onChange:Z,className:"hidden",multiple:!0,disabled:s.status==="Fechado"&&s.jaFoiRevisado}),e.jsx("textarea",{value:v,onChange:a=>I(a.target.value),onKeyDown:a=>{a.key==="Enter"&&!a.shiftKey&&(a.preventDefault(),M(a))},placeholder:s.status==="Fechado"&&s.jaFoiRevisado?"Chamado finalizado. Não é possível enviar mensagens.":"Digite sua mensagem...",className:"flex-1 bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none resize-none max-h-32 disabled:bg-gray-100 disabled:text-gray-400 disabled:cursor-not-allowed",rows:1,disabled:s.status==="Fechado"&&s.jaFoiRevisado}),e.jsx("button",{type:"submit",disabled:A||!v.trim()&&x.length===0||s.status==="Fechado"&&s.jaFoiRevisado,className:"p-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl shadow-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed",children:A?e.jsx("div",{className:"w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"}):e.jsx(fe,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"flex justify-center pt-4 border-t border-gray-100 mt-4",children:e.jsx("button",{onClick:async()=>{if(s.status==="Fechado"){if(s.jaFoiRevisado)return;m({isOpen:!0,title:"Reabrir Chamado?",message:"Deseja reabrir este chamado para revisão?",variant:"warning",confirmText:"Sim, Reabrir",onConfirm:async()=>{try{const a={autor:"Sistema",mensagem:`Chamado reaberto para revisão por ${p()}`,data:new Date().toISOString()};await g(u(d,"chamados",n),{status:"Revisão",jaFoiRevisado:!0,dataAtualizacao:new Date().toISOString(),interacoes:b(a)}),c.success("Chamado em revisão."),m(t=>({...t,isOpen:!1}))}catch(a){console.error(a),c.error("Erro ao alterar status.")}}})}else m({isOpen:!0,title:"Finalizar Chamado?",message:"Deseja finalizar este chamado?",variant:"info",confirmText:"Sim, Finalizar",onConfirm:async()=>{try{const a={autor:"Sistema",mensagem:`Chamado finalizado por ${p()}`,data:new Date().toISOString()};await g(u(d,"chamados",n),{status:"Fechado",dataAtualizacao:new Date().toISOString(),interacoes:b(a)}),c.success("Chamado finalizado!"),m(t=>({...t,isOpen:!1}))}catch(a){console.error(a),c.error("Erro ao finalizar.")}}})},disabled:s.status==="Fechado"&&s.jaFoiRevisado,className:`px-6 py-2 rounded-lg font-bold text-white shadow-sm transition-all transform active:scale-95 flex items-center gap-2 text-sm ${s.status==="Fechado"?s.jaFoiRevisado?"bg-gray-400 cursor-not-allowed":"bg-orange-500 hover:bg-orange-600":"bg-green-600 hover:bg-green-700"}`,children:s.status==="Fechado"?s.jaFoiRevisado?e.jsxs(e.Fragment,{children:[e.jsx(q,{className:"w-4 h-4"}),"Chamado Finalizado"]}):e.jsxs(e.Fragment,{children:[e.jsx(V,{className:"w-4 h-4"}),"Revisar"]}):e.jsxs(e.Fragment,{children:[e.jsx(q,{className:"w-4 h-4"}),"Finalizar Chamado"]})})})]})]}),e.jsx("div",{className:"w-full lg:w-80 space-y-6 pr-1 custom-scrollbar",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-gray-200 p-5 space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-xs font-bold text-gray-500 uppercase flex items-center gap-1",children:[e.jsx(V,{className:"w-4 h-4"})," Tipo"]}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:s.tipo||"",onChange:async a=>{const t=a.target.value;m({isOpen:!0,title:"Alterar Tipo?",message:`Deseja alterar o tipo para "${t}"?`,variant:"warning",onConfirm:async()=>{try{const r={autor:"Sistema",mensagem:`Tipo alterado para ${t} por ${p()}`,data:new Date().toISOString()};await g(u(d,"chamados",n),{tipo:t,tipoAlterado:!0,dataAtualizacao:new Date().toISOString(),interacoes:b(r)}),c.success(`Tipo alterado para: ${t}`),m(o=>({...o,isOpen:!1}))}catch(r){console.error("Error updating type:",r),c.error("Erro ao alterar tipo.")}}})},disabled:N,className:`w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg appearance-none text-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none font-medium text-base ${N?"opacity-60 cursor-not-allowed bg-gray-100":"cursor-pointer hover:border-blue-300"}`,children:[e.jsx("option",{value:"Devolucao",children:"Devolução"}),e.jsx("option",{value:"Reembolso",children:"Reembolso"}),e.jsx("option",{value:"Fraude",children:"Fraude"}),e.jsx("option",{value:"Contatar MarketPlace",children:"Contatar MarketPlace"}),e.jsx("option",{value:"Contatar Cliente",children:"Contatar Cliente"}),e.jsx("option",{value:"Interno",children:"Interno"}),e.jsx("option",{value:"Defeito",children:"Defeito"}),e.jsx("option",{value:"Prejuizo",children:"Prejuízo"}),e.jsx("option",{value:"Atraso na entrega",children:"Atraso na entrega"}),e.jsx("option",{value:"Produto errado",children:"Produto errado"}),e.jsx("option",{value:"Faltou item",children:"Faltou item"}),e.jsx("option",{value:"Duvida tecnica",children:"Dúvida técnica"}),e.jsx("option",{value:"Cancelamento",children:"Cancelamento"})]}),N&&e.jsx(C,{className:"absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"})]}),N&&e.jsxs("p",{className:"text-xs text-orange-500 flex items-center gap-1",children:[e.jsx(C,{className:"w-3 h-3"})," Alteração única permitida."]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-400 uppercase font-bold",children:"Pedido"}),e.jsx("p",{className:"text-lg font-bold text-gray-800",children:s.pedido||"N/A"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-400 uppercase font-bold",children:"Marketplace"}),e.jsx("p",{className:"text-sm font-medium text-gray-700",children:s.marketplace||"N/A"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-xs font-bold text-gray-500 uppercase flex items-center gap-1",children:[e.jsx(xe,{className:"w-4 h-4"})," Responsável"]}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:s.responsavel||"",onChange:X,disabled:w,className:`w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg appearance-none text-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none font-medium ${w?"opacity-60 cursor-not-allowed bg-gray-100":"cursor-pointer hover:border-blue-300"}`,children:[e.jsx("option",{value:"",disabled:!0,children:"Selecionar..."}),D.map(a=>e.jsx("option",{value:a.nome,children:a.nome},a.id))]}),w&&e.jsx(C,{className:"absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"})]}),w&&e.jsxs("p",{className:"text-xs text-orange-500 flex items-center gap-1",children:[e.jsx(C,{className:"w-3 h-3"})," Alteração única permitida."]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-xs font-bold text-gray-500 uppercase flex items-center gap-1",children:[e.jsx(me,{className:"w-4 h-4"})," Data de Retorno"]}),e.jsx("input",{type:"date",value:s.dataRetorno||"",onChange:async a=>{const t=a.target.value;try{const r={autor:"Sistema",mensagem:`Data de retorno alterada para ${be(t)} por ${p()}`,data:new Date().toISOString()};await g(u(d,"chamados",n),{dataRetorno:t,dataAtualizacao:new Date().toISOString(),interacoes:b(r)}),c.success("Data de retorno atualizada!")}catch(r){console.error("Error updating date:",r),c.error("Erro ao alterar data de retorno.")}},className:"w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg text-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none font-medium"})]}),e.jsx("hr",{className:"border-gray-100"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-400 uppercase font-bold mb-1",children:"Aberto em"}),e.jsxs("div",{className:"flex items-center gap-2 text-gray-600 font-medium text-sm",children:[e.jsx(ue,{className:"w-4 h-4 text-gray-400"}),new Date(s.dataAbertura).toLocaleString("pt-BR")]})]}),s.anexos&&s.anexos.length>0&&e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-400 uppercase font-bold mb-2",children:"Anexos do Chamado"}),e.jsx("div",{className:"flex flex-col gap-2",children:s.anexos.map((a,t)=>e.jsx(P,{anexo:a,compact:!0},t))})]})]})]})})]}),U&&e.jsxs("div",{className:"fixed inset-0 z-50 bg-black/90 flex items-center justify-center p-4 backdrop-blur-sm",onClick:()=>F(null),children:[e.jsx("button",{className:"absolute top-4 right-4 text-white hover:text-gray-300 p-2",onClick:()=>F(null),children:e.jsx(T,{className:"w-8 h-8"})}),e.jsx("img",{src:U,alt:"Preview",className:"max-w-full max-h-[90vh] object-contain rounded-lg shadow-2xl",onClick:a=>a.stopPropagation()})]}),e.jsx(ie,{isOpen:f.isOpen,onClose:()=>m(a=>({...a,isOpen:!1})),onConfirm:f.onConfirm,title:f.title,message:f.message,variant:f.variant,confirmText:f.confirmText})]})}export{Oe as default};
