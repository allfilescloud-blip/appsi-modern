import{h as xe,r as c,q as T,m as F,k as R,o as ue,j as e,a as x,Q as d,E as ge,l as pe,z as he,b as be,y as U,d as D,C as fe,p as G,t as P,F as je,v as ye,x as Ne}from"./index-B-L-ggBM.js";import{L as V,S as ve}from"./sweetalert2.esm.all-BzkSASJs.js";import{A as we}from"./alert-triangle-ZcrmWvKL.js";import{P as X}from"./plus-CxdefbJw.js";import{S as W}from"./search-C3X76pFT.js";import{E as K}from"./eye-C8E-8hc5.js";import{P as y}from"./pen-square-BAjpZPi3.js";import{T as M}from"./trash-2-BXHS6SWb.js";import{X as N}from"./x-B9n1pji0.js";import{U as ke}from"./upload-B2N6nusu.js";import{c as Ce}from"./createLucideIcon-DYDWZ736.js";import{S as Se}from"./save-CZFTHF0Y.js";/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Q=Ce("Image",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["circle",{cx:"9",cy:"9",r:"2",key:"af1f0g"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21",key:"1xmnt7"}]]);function Te(){const{userData:Ee}=xe(),[Z,L]=c.useState(!0),[b,A]=c.useState(!1),[H,J]=c.useState([]),[f,Y]=c.useState(""),[ee,u]=c.useState(!1),[O,j]=c.useState(!1),[se,v]=c.useState(!1),[r,w]=c.useState(null),[q,te]=c.useState(null),[i,m]=c.useState({code:"",location:"",description:"",correction:"",notes:""}),[g,p]=c.useState([]),B=c.useRef(null),k=3,ae=2*1024*1024;c.useEffect(()=>{const s=T(R(x,"erros_suporte"),F("createdAt","desc")),t=ue(s,a=>{const o=a.docs.map(n=>({id:n.id,...n.data()}));J(o),L(!1)},a=>{console.error("Error fetching records:",a),d.error("Erro ao carregar registros."),L(!1)});return()=>t()},[]);const C=H.filter(s=>{var a,o,n;const t=f.toLowerCase();return(((a=s.code)==null?void 0:a.toLowerCase())||"").includes(t)||(((o=s.description)==null?void 0:o.toLowerCase())||"").includes(t)||(((n=s.location)==null?void 0:n.toLowerCase())||"").includes(t)}),re=s=>{Y(s.target.value)},oe=async()=>{m({code:"Gerando...",location:"",description:"",correction:"",notes:""}),p([]),w(null),u(!0);const s=await le();m(t=>({...t,code:s}))},S=s=>{w(s),m({code:s.code,location:s.location||"",description:s.description||"",correction:s.correction||"",notes:s.notes||""}),s.imagens&&s.imagens.length>0?p(s.imagens.map(t=>({...t,isExisting:!0}))):p([]),u(!0)},_=s=>{w(s),j(!0)},le=async()=>{try{const s=T(R(x,"erros_suporte"),F("code","desc"),ge(1)),t=await pe(s);let a=1;if(!t.empty){const o=t.docs[0].data().code;if(o&&o.startsWith("ERR")){const n=o.substring(3),l=parseInt(n,10);isNaN(l)||(a=l+1)}}return`ERR${String(a).padStart(4,"0")}`}catch(s){return console.error("Error generating code:",s),`ERR${Date.now().toString().slice(-4)}`}},ie=s=>{const t=Array.from(s.target.files);if(t.length===0)return;const a=[];let o="";if(g.length+t.length>k){d.error(`Máximo de ${k} imagens permitidas.`);return}t.forEach(l=>{l.type.startsWith("image/")?l.size>ae?o="Imagem muito grande (max 2MB).":a.push(l):o="Apenas imagens são permitidas."}),o&&d.error(o);const n=a.map(l=>({file:l,url:URL.createObjectURL(l),name:l.name,size:l.size,isExisting:!1}));p(l=>[...l,...n]),s.target.value=""},ne=s=>{p(t=>t.filter((a,o)=>o!==s))},ce=async(s,t)=>{const a=[];for(const o of t){if(o.isExisting){a.push(o);continue}try{const n=o.name.split(".").pop(),l=`suporte/${s}/${Date.now()}_${Math.random().toString(36).substring(2,9)}.${n}`,h=G(P,l),z=await ye(h,o.file),I=await Ne(z.ref);a.push({nome:o.name,url:I,caminho:l,tamanho:o.size})}catch(n){console.error(`Error uploading ${o.name}:`,n),d.error(`Erro ao enviar imagem ${o.name}`)}}return a},$=async s=>{for(const t of s)if(t.caminho)try{const a=G(P,t.caminho);await je(a)}catch(a){console.error("Error deleting image from storage:",a)}},de=async s=>{var t;s.preventDefault(),A(!0);try{let a=r==null?void 0:r.id,o=i.code;if(r||(a=(await he(R(x,"erros_suporte"),{createdAt:new Date().toISOString(),loading:!0})).id),r&&r.imagens){const h=r.imagens.filter(z=>!g.some(I=>I.url===z.url));h.length>0&&await $(h)}const n=await ce(a,g),l={code:o,location:i.location,description:i.description,correction:i.correction,notes:i.notes,imagens:n,updatedAt:new Date().toISOString(),userId:((t=be.currentUser)==null?void 0:t.uid)||"unknown"};r?(await U(D(x,"erros_suporte",a),l),d.success("Registro atualizado com sucesso!")):(l.createdAt=new Date().toISOString(),await U(D(x,"erros_suporte",a),l),d.success("Registro criado com sucesso!")),u(!1)}catch(a){console.error("Error saving record:",a),d.error("Erro ao salvar registro: "+a.message)}finally{A(!1)}},E=async s=>{if((await ve.fire({title:"Tem certeza?",text:"Você não poderá reverter isso!",icon:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"Sim, excluir!",cancelButtonText:"Cancelar"})).isConfirmed)try{s.imagens&&s.imagens.length>0&&await $(s.imagens),await fe(D(x,"erros_suporte",s.id)),d.success("Registro excluído."),O&&j(!1)}catch(a){console.error("Error deleting:",a),d.error("Erro ao excluir registro.")}},me=s=>s?new Date(s).toLocaleString("pt-BR"):"N/A";return e.jsxs("div",{className:"p-4 md:p-6 max-w-[1600px] mx-auto",children:[e.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-2xl font-bold text-gray-800 flex items-center gap-2",children:[e.jsx(we,{className:"w-8 h-8 text-orange-500"}),"Registro de Erros"]}),e.jsx("p",{className:"text-gray-500 text-sm mt-1",children:"Gerenciamento e rastreamento de erros operacionais"})]}),e.jsxs("button",{onClick:oe,className:"flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors font-medium shadow-sm w-full md:w-auto justify-center",children:[e.jsx(X,{size:20}),"Novo Registro"]})]}),e.jsx("div",{className:"bg-white p-4 rounded-xl shadow-sm border border-gray-200 mb-6",children:e.jsxs("div",{className:"relative",children:[e.jsx(W,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5"}),e.jsx("input",{type:"text",placeholder:"Buscar por código, local ou descrição...",className:"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all",value:f,onChange:re})]})}),Z?e.jsx("div",{className:"flex justify-center items-center py-20",children:e.jsx(V,{className:"w-8 h-8 text-blue-600 animate-spin"})}):C.length===0?e.jsxs("div",{className:"text-center py-16 bg-white rounded-xl shadow-sm border border-gray-200",children:[e.jsx("div",{className:"flex justify-center mb-4",children:e.jsx("div",{className:"p-4 bg-gray-100 rounded-full",children:e.jsx(W,{className:"w-8 h-8 text-gray-400"})})}),e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"Nenhum registro encontrado"}),e.jsx("p",{className:"text-gray-500 mt-1 max-w-sm mx-auto",children:f?`Não encontramos resultados para "${f}"`:"Nenhum erro registrado ainda. Clique em 'Novo Registro' para começar."})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"hidden lg:block bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-left border-collapse min-w-[1000px]",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-50 border-b border-gray-200 text-xs uppercase text-gray-500 font-semibold",children:[e.jsx("th",{className:"px-6 py-4 w-24",children:"Código"}),e.jsx("th",{className:"px-6 py-4 w-48",children:"Local"}),e.jsx("th",{className:"px-6 py-4",children:"Descrição do Erro"}),e.jsx("th",{className:"px-6 py-4",children:"Correção"}),e.jsx("th",{className:"px-6 py-4 text-right w-32",children:"Ações"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100",children:C.map(s=>e.jsxs("tr",{className:"hover:bg-gray-50 transition-colors",children:[e.jsx("td",{className:"px-6 py-4",children:e.jsx("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800",children:s.code})}),e.jsx("td",{className:"px-6 py-4 text-sm text-gray-700 font-medium",children:s.location||"-"}),e.jsx("td",{className:"px-6 py-4 text-sm text-gray-600",children:e.jsx("div",{className:"line-clamp-2 max-w-md",title:s.description,children:s.description})}),e.jsx("td",{className:"px-6 py-4 text-sm text-gray-600",children:e.jsx("div",{className:"line-clamp-2 max-w-md",title:s.correction,children:s.correction})}),e.jsx("td",{className:"px-6 py-4 text-right",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("button",{onClick:()=>_(s),className:"p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors",title:"Visualizar",children:e.jsx(K,{size:18})}),e.jsx("button",{onClick:()=>S(s),className:"p-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors",title:"Editar",children:e.jsx(y,{size:18})}),e.jsx("button",{onClick:()=>E(s),className:"p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors",title:"Excluir",children:e.jsx(M,{size:18})})]})})]},s.id))})]})})}),e.jsx("div",{className:"lg:hidden grid gap-4",children:C.map(s=>e.jsxs("div",{className:"bg-white p-4 rounded-xl shadow-sm border border-gray-200 hover:shadow-md transition-shadow",children:[e.jsxs("div",{className:"flex justify-between items-start mb-3",children:[e.jsx("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800",children:s.code}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:()=>_(s),className:"p-1.5 text-blue-600 hover:bg-blue-50 rounded-lg",children:e.jsx(K,{size:16})}),e.jsx("button",{onClick:()=>S(s),className:"p-1.5 text-gray-600 hover:bg-gray-100 rounded-lg",children:e.jsx(y,{size:16})}),e.jsx("button",{onClick:()=>E(s),className:"p-1.5 text-red-600 hover:bg-red-50 rounded-lg",children:e.jsx(M,{size:16})})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-xs text-gray-400 uppercase font-semibold",children:"Local"}),e.jsx("p",{className:"text-sm font-medium text-gray-800",children:s.location||"Não informado"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-xs text-gray-400 uppercase font-semibold",children:"Descrição"}),e.jsx("p",{className:"text-sm text-gray-600 line-clamp-2",children:s.description})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-xs text-gray-400 uppercase font-semibold",children:"Correção"}),e.jsx("p",{className:"text-sm text-gray-600 line-clamp-2",children:s.correction||"-"})]})]})]},s.id))})]}),ee&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4 transition-opacity",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto animate-in fade-in zoom-in duration-200",children:[e.jsxs("div",{className:"sticky top-0 bg-white border-b border-gray-100 p-4 flex justify-between items-center z-10",children:[e.jsxs("h2",{className:"text-xl font-bold text-gray-800 flex items-center gap-2",children:[r?e.jsx(y,{className:"text-blue-600",size:24}):e.jsx(X,{className:"text-blue-600",size:24}),r?"Editar Registro":"Novo Registro"]}),e.jsx("button",{onClick:()=>u(!1),className:"p-2 hover:bg-gray-100 rounded-full transition-colors text-gray-500",children:e.jsx(N,{size:20})})]}),e.jsxs("form",{onSubmit:de,className:"p-6 space-y-5",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-5",children:[e.jsxs("div",{className:"md:col-span-1",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Código"}),e.jsx("input",{type:"text",className:`w-full p-2.5 border rounded-lg font-mono focus:outline-none ${r?"bg-gray-100 border-gray-200 text-gray-500 cursor-not-allowed":"bg-white border-gray-300 text-gray-900 focus:ring-2 focus:ring-blue-500"}`,value:i.code,onChange:s=>!r&&m({...i,code:s.target.value}),readOnly:!!r}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:r?"Gerado automaticamente":"Gerado automaticamente (editável)"})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Local / Módulo"}),e.jsx("input",{type:"text",required:!0,placeholder:"Ex: Página de Login, Estoque, etc.",className:"w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none",value:i.location,onChange:s=>m({...i,location:s.target.value})})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Descrição do Erro"}),e.jsx("textarea",{required:!0,rows:"3",placeholder:"Descreva o erro detalhadamente...",className:"w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none resize-none",value:i.description,onChange:s=>m({...i,description:s.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Correção Aplicada"}),e.jsx("textarea",{rows:"2",placeholder:"O que foi feito para corrigir? (Opcional)",className:"w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none resize-none",value:i.correction,onChange:s=>m({...i,correction:s.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Observações"}),e.jsx("input",{type:"text",placeholder:"Notas adicionais...",className:"w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none",value:i.notes,onChange:s=>m({...i,notes:s.target.value})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Evidências (Imagens)"}),e.jsxs("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-6 flex flex-col items-center justify-center bg-gray-50 hover:bg-gray-100 transition-colors cursor-pointer relative",onClick:()=>{var s;return(s=B.current)==null?void 0:s.click()},children:[e.jsx("input",{type:"file",ref:B,className:"absolute inset-0 w-full h-full opacity-0 cursor-pointer",accept:"image/*",multiple:!0,onChange:ie}),e.jsx(ke,{className:"w-8 h-8 text-gray-400 mb-2"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Clique ou arraste imagens aqui"}),e.jsxs("p",{className:"text-xs text-gray-400 mt-1",children:["Máx. ",k," imagens (2MB cada)"]})]}),g.length>0&&e.jsx("div",{className:"mt-4 space-y-2",children:g.map((s,t)=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[s.isExisting?e.jsx(Q,{className:"w-5 h-5 text-blue-600"}):e.jsx(Q,{className:"w-5 h-5 text-gray-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-700 truncate",children:s.name}),e.jsxs("p",{className:"text-xs text-gray-500",children:[(s.size/1024).toFixed(1)," KB ",s.isExisting&&"(Existente)"]})]})]}),e.jsx("button",{type:"button",onClick:()=>ne(t),className:"text-gray-400 hover:text-red-500 p-1",children:e.jsx(N,{className:"w-5 h-5"})})]},t))})]}),e.jsxs("div",{className:"pt-4 flex justify-end gap-3 border-t border-gray-100",children:[e.jsx("button",{type:"button",onClick:()=>u(!1),className:"px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition-colors",disabled:b,children:"Cancelar"}),e.jsxs("button",{type:"submit",className:"px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg shadow-sm flex items-center gap-2 transition-all disabled:opacity-70 disabled:cursor-not-allowed",disabled:b,children:[b?e.jsx(V,{size:18,className:"animate-spin"}):e.jsx(Se,{size:18}),b?"Salvando...":"Salvar"]})]})]})]})}),O&&r&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4 transition-opacity",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto animate-in fade-in zoom-in duration-200",children:[e.jsxs("div",{className:"sticky top-0 bg-white border-b border-gray-100 p-4 flex justify-between items-center z-10",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-gray-800",children:"Detalhes do Registro"}),e.jsx("span",{className:"text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full font-mono mt-1 inline-block",children:r.code})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>{j(!1),S(r)},className:"p-2 hover:bg-gray-100 rounded-full transition-colors text-blue-600",title:"Editar",children:e.jsx(y,{size:20})}),e.jsx("button",{onClick:()=>E(r),className:"p-2 hover:bg-gray-100 rounded-full transition-colors text-red-600",title:"Excluir",children:e.jsx(M,{size:20})}),e.jsx("button",{onClick:()=>j(!1),className:"p-2 hover:bg-gray-100 rounded-full transition-colors text-gray-500",children:e.jsx(N,{size:20})})]})]}),e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1",children:"Local"}),e.jsx("p",{className:"text-gray-900 font-medium",children:r.location||"Não informado"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1",children:"Data de Criação"}),e.jsx("p",{className:"text-gray-900",children:me(r.createdAt)})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1",children:"Descrição"}),e.jsx("div",{className:"bg-gray-50 p-3 rounded-lg border border-gray-100 text-gray-800 text-sm leading-relaxed whitespace-pre-wrap",children:r.description})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1",children:"Correção"}),e.jsx("div",{className:"bg-green-50 p-3 rounded-lg border border-green-100 text-gray-800 text-sm leading-relaxed whitespace-pre-wrap",children:r.correction||"Nenhuma correção registrada."})]}),r.notes&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-semibold text-gray-400 uppercase tracking-wider mb-1",children:"Observações"}),e.jsx("p",{className:"text-gray-600 text-sm",children:r.notes})]}),r.imagens&&r.imagens.length>0&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2",children:"Evidências"}),e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 gap-3",children:r.imagens.map((s,t)=>e.jsxs("div",{className:"cursor-pointer rounded-lg overflow-hidden border border-gray-200 hover:ring-2 hover:ring-blue-500 transition-all aspect-video group relative",onClick:()=>{te(s.url),v(!0)},children:[e.jsx("img",{src:s.url,alt:s.nome,className:"w-full h-full object-cover"}),e.jsx("div",{className:"absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors"})]},t))})]})]})]})}),se&&q&&e.jsxs("div",{className:"fixed inset-0 z-[60] flex items-center justify-center bg-black/90 p-4 backdrop-blur-sm",onClick:()=>v(!1),children:[e.jsx("button",{className:"absolute top-4 right-4 text-white hover:text-gray-300 transition-colors bg-white/10 p-2 rounded-full",onClick:()=>v(!1),children:e.jsx(N,{size:24})}),e.jsx("img",{src:q,alt:"Expanded",className:"max-w-full max-h-[90vh] object-contain rounded shadow-2xl"})]})]})}export{Te as default};
