import{n as G,u as J,r as l,o as Y,d as u,y as p,j as e,b as h,a as d,A as g,Q as i,l as ee,k as z,z as ae,p as se,t as te,v as re,x as oe}from"./index-BvKRNp9f.js";import{A as ne}from"./arrow-left-DCS65u-3.js";import{X as M}from"./x-IbEMtz5s.js";import{P as le}from"./paperclip-CL65kGB4.js";import{c as R}from"./createLucideIcon-CN9yn7JJ.js";import{C as T}from"./check-circle-D5cTKWZI.js";import{A as O,C as ie}from"./clock-D7XXdvqX.js";import{U as ce}from"./user-DQjU8huL.js";import{F as de}from"./file-text-Bne6Wy9R.js";import{E as me}from"./eye-Dgcto5E-.js";/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ue=R("Download",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"7 10 12 15 17 10",key:"2ggqvy"}],["line",{x1:"12",x2:"12",y1:"15",y2:"3",key:"1vk2je"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const v=R("Lock",[["rect",{width:"18",height:"11",x:"3",y:"11",rx:"2",ry:"2",key:"1w4ew1"}],["path",{d:"M7 11V7a5 5 0 0 1 10 0v4",key:"fwvmzm"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xe=R("Send",[["path",{d:"m22 2-7 20-4-9-9-4Z",key:"1q3vgg"}],["path",{d:"M22 2 11 13",key:"nzbqef"}]]);function Se(){const{id:c}=G(),y=J(),[s,q]=l.useState(null),[V,F]=l.useState(!0),[w,_]=l.useState([]),[b,A]=l.useState(""),[m,N]=l.useState([]),[C,$]=l.useState(!1),E=l.useRef(null),I=l.useRef(null),[f,B]=l.useState(!1),[pe,H]=l.useState(!1),[j,K]=l.useState(!1),[U,S]=l.useState(null);l.useEffect(()=>{(async()=>{try{const o=(await ee(z(d,"usuarios"))).docs.map(n=>({id:n.id,...n.data()}));_(o)}catch(r){console.error("Error loading users:",r)}})();const t=Y(u(d,"chamados",c),r=>{if(r.exists()){const o=r.data();q({id:r.id,...o}),B(!!o.responsavelAlterado),H(!!o.statusAlterado),K(!!o.tipoAlterado),F(!1)}else i.error("Chamado não encontrado."),y("/chamados")},r=>{console.error("Error fetching ticket:",r),i.error("Erro ao carregar chamado."),F(!1)});return()=>t()},[c,y]),l.useEffect(()=>{if((s==null?void 0:s.status)==="Aberto"&&(s!=null&&s.dataAbertura)){const a=new Date(s.dataAbertura);(new Date-a)/(1e3*60*60)>24&&p(u(d,"chamados",c),{status:"Pendente"})}},[s,c]),l.useEffect(()=>{var a;(a=I.current)==null||a.scrollIntoView({behavior:"smooth"})},[s==null?void 0:s.interacoes]);const x=()=>{if(!h.currentUser)return"Usuário";const a=w.find(t=>t.email===h.currentUser.email);return(a==null?void 0:a.nome)||h.currentUser.displayName||h.currentUser.email||"Usuário"},Q=async a=>{const t=a.target.value,r=w.find(n=>n.nome===t);if(!r)return;const o=r.nome;if(window.confirm(`Confirma a atribuição deste chamado para ${o}? Esta ação não poderá ser desfeita.`))try{const n={autor:"Sistema",mensagem:`Responsável alterado para ${o} por ${x()}`,data:new Date().toISOString()};await p(u(d,"chamados",c),{responsavel:o,responsavelAlterado:!0,interacoes:g(n)}),await ae(z(d,"notificacoes"),{para:o,mensagem:`Você foi atribuído ao chamado ${s.codigo}`,lido:!1,data:new Date().toISOString(),link:`/chamados/${c}`}),i.success(`Responsável atribuído: ${o}`)}catch(n){console.error("Error updating responsible:",n),i.error("Erro ao atribuir responsável.")}},W=a=>{a.target.files&&N([...m,...Array.from(a.target.files)])},X=a=>{N(m.filter((t,r)=>r!==a))},P=async a=>{if(a.preventDefault(),!(!b.trim()&&m.length===0||C)){$(!0);try{const t=[];for(const o of m){const n=se(te,`chamados/${c}/${Date.now()}_${o.name}`),k=await re(n,o),D=await oe(k.ref);t.push({nome:o.name,url:D,tipo:o.type})}const r={autor:x(),mensagem:b,data:new Date().toISOString(),anexos:t};await p(u(d,"chamados",c),{interacoes:g(r),...s.status==="Aberto"?{status:"Pendente"}:{}}),A(""),N([]),i.success("Mensagem enviada!")}catch(t){console.error("Error sending message:",t),i.error("Erro ao enviar mensagem.")}finally{$(!1)}}},Z=a=>{switch(a){case"Aberto":return"bg-blue-100 text-blue-800";case"Pendente":return"bg-yellow-100 text-yellow-800";case"Revisão":return"bg-purple-100 text-purple-800";case"Fechado":return"bg-green-100 text-green-800";default:return"bg-gray-100 text-gray-800"}};if(V)return e.jsx("div",{className:"p-10 text-center",children:"Carregando detalhes..."});if(!s)return null;const L=({anexo:a,compact:t=!1})=>{var o;const r=((o=a.tipo)==null?void 0:o.startsWith("image/"))||a.nome.match(/\.(jpg|jpeg|png|gif|webp)$/i);return e.jsxs("div",{className:`flex items-center justify-between gap-2 bg-gray-50 border border-gray-200 px-3 py-2 rounded-lg transition-colors group ${t?"text-xs":"text-sm"}`,children:[e.jsxs("div",{className:"flex items-center gap-2 overflow-hidden",children:[e.jsx(de,{className:`text-gray-400 group-hover:text-blue-500 transition-colors ${t?"w-3 h-3":"w-4 h-4"}`}),e.jsx("span",{className:"text-gray-700 truncate max-w-[150px]",children:a.nome})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:n=>{n.preventDefault(),r?S(a.url):window.open(a.url,"_blank")},className:"p-1 text-gray-500 hover:text-blue-600 hover:bg-blue-50 rounded transition-colors",title:"Visualização Rápida",children:e.jsx(me,{className:t?"w-3 h-3":"w-4 h-4"})}),e.jsx("a",{href:a.url,target:"_blank",rel:"noopener noreferrer",className:"p-1 text-gray-500 hover:text-green-600 hover:bg-green-50 rounded transition-colors",title:"Download / Abrir Original",children:e.jsx(ue,{className:t?"w-3 h-3":"w-4 h-4"})})]})]})};return e.jsxs("div",{className:"max-w-6xl mx-auto space-y-6 pb-10 min-h-[calc(100dvh-100px)] lg:h-[calc(100dvh-100px)] flex flex-col relative",children:[e.jsxs("div",{className:"flex items-center gap-4 mb-2",children:[e.jsx("button",{onClick:()=>y("/chamados"),className:"p-2 hover:bg-gray-100 rounded-full transition-colors",children:e.jsx(ne,{className:"w-6 h-6 text-gray-600"})}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-800",children:s.codigo}),e.jsx("span",{className:`px-3 py-1 rounded-full text-sm font-bold ${Z(s.status)}`,children:s.status})]}),e.jsx("p",{className:"text-gray-500 text-sm mt-1",children:s.tipo})]})]}),e.jsxs("div",{className:"flex flex-col lg:flex-row gap-6 h-full overflow-hidden",children:[e.jsxs("div",{className:"flex-1 bg-white rounded-xl shadow-sm border border-gray-200 flex flex-col lg:overflow-hidden",children:[e.jsxs("div",{className:"p-4 border-b border-gray-100 bg-gray-50/30",children:[s.assunto&&e.jsxs("div",{className:"mb-3 pb-3 border-b border-gray-100",children:[e.jsx("p",{className:"text-xs text-gray-400 uppercase font-bold mb-1",children:"Assunto"}),e.jsx("h2",{className:"text-lg font-bold text-gray-800 leading-snug",children:s.assunto})]}),e.jsx("p",{className:"text-xs text-gray-400 uppercase font-bold mb-1",children:"Descrição do Problema"}),e.jsx("p",{className:"text-gray-700 text-sm whitespace-pre-wrap leading-relaxed",children:s.descricao})]}),e.jsxs("div",{className:"flex-1 lg:overflow-y-auto p-4 space-y-4 bg-gray-50/50",children:[s.interacoes&&s.interacoes.map((a,t)=>{var n;const r=x(),o=a.autor===r||a.autor===((n=h.currentUser)==null?void 0:n.email);return e.jsx("div",{className:`flex flex-col ${a.autor==="Sistema"?"items-center my-4":o?"items-end":"items-start"}`,children:a.autor==="Sistema"?e.jsx("div",{className:"bg-gray-200 text-gray-600 px-4 py-1 rounded-full text-xs font-bold uppercase tracking-wider shadow-sm",children:a.mensagem}):e.jsxs("div",{className:`max-w-[80%] ${o?"bg-blue-600 text-white rounded-l-xl rounded-tr-xl":"bg-white border border-gray-200 text-gray-800 rounded-r-xl rounded-tl-xl"} p-4 shadow-sm`,children:[e.jsxs("div",{className:"flex justify-between items-center gap-4 mb-1 opacity-80 text-xs",children:[e.jsx("span",{className:"font-bold",children:a.autor}),e.jsx("span",{children:new Date(a.data).toLocaleString("pt-BR")})]}),e.jsx("p",{className:"whitespace-pre-wrap leading-relaxed",children:a.mensagem}),a.anexos&&a.anexos.length>0&&e.jsx("div",{className:"mt-3 space-y-2",children:a.anexos.map((k,D)=>e.jsx(L,{anexo:k},D))})]})},t)}),e.jsx("div",{ref:I})]}),e.jsxs("div",{className:"p-4 bg-white border-t border-gray-200",children:[m.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2 mb-3",children:m.map((a,t)=>e.jsxs("div",{className:"flex items-center gap-2 bg-blue-50 text-blue-700 px-3 py-1 rounded-full text-sm border border-blue-100",children:[e.jsx("span",{className:"max-w-[150px] truncate",children:a.name}),e.jsx("button",{onClick:()=>X(t),className:"hover:text-blue-900",children:e.jsx(M,{className:"w-4 h-4"})})]},t))}),e.jsxs("form",{onSubmit:P,className:"flex gap-2 items-end",children:[e.jsx("button",{type:"button",onClick:()=>{var a;return(a=E.current)==null?void 0:a.click()},className:"p-3 text-gray-500 hover:bg-gray-100 rounded-xl transition-colors disabled:opacity-50 disabled:cursor-not-allowed",title:"Anexar arquivo",disabled:s.status==="Fechado"&&s.jaFoiRevisado,children:e.jsx(le,{className:"w-5 h-5"})}),e.jsx("input",{type:"file",ref:E,onChange:W,className:"hidden",multiple:!0,disabled:s.status==="Fechado"&&s.jaFoiRevisado}),e.jsx("textarea",{value:b,onChange:a=>A(a.target.value),onKeyDown:a=>{a.key==="Enter"&&!a.shiftKey&&(a.preventDefault(),P(a))},placeholder:s.status==="Fechado"&&s.jaFoiRevisado?"Chamado finalizado. Não é possível enviar mensagens.":"Digite sua mensagem...",className:"flex-1 bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none resize-none max-h-32 disabled:bg-gray-100 disabled:text-gray-400 disabled:cursor-not-allowed",rows:1,disabled:s.status==="Fechado"&&s.jaFoiRevisado}),e.jsx("button",{type:"submit",disabled:C||!b.trim()&&m.length===0||s.status==="Fechado"&&s.jaFoiRevisado,className:"p-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl shadow-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed",children:C?e.jsx("div",{className:"w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"}):e.jsx(xe,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"flex justify-center pt-4 border-t border-gray-100 mt-4",children:e.jsx("button",{onClick:async()=>{if(s.status==="Fechado"){if(s.jaFoiRevisado)return;if(window.confirm("Deseja reabrir este chamado para revisão?"))try{const a={autor:"Sistema",mensagem:`Chamado reaberto para revisão por ${x()}`,data:new Date().toISOString()};await p(u(d,"chamados",c),{status:"Revisão",jaFoiRevisado:!0,interacoes:g(a)}),i.success("Chamado em revisão.")}catch(a){console.error(a),i.error("Erro ao alterar status.")}}else if(window.confirm("Deseja finalizar este chamado?"))try{const a={autor:"Sistema",mensagem:`Chamado finalizado por ${x()}`,data:new Date().toISOString()};await p(u(d,"chamados",c),{status:"Fechado",interacoes:g(a)}),i.success("Chamado finalizado!")}catch(a){console.error(a),i.error("Erro ao finalizar.")}},disabled:s.status==="Fechado"&&s.jaFoiRevisado,className:`px-6 py-2 rounded-lg font-bold text-white shadow-sm transition-all transform active:scale-95 flex items-center gap-2 text-sm ${s.status==="Fechado"?s.jaFoiRevisado?"bg-gray-400 cursor-not-allowed":"bg-orange-500 hover:bg-orange-600":"bg-green-600 hover:bg-green-700"}`,children:s.status==="Fechado"?s.jaFoiRevisado?e.jsxs(e.Fragment,{children:[e.jsx(T,{className:"w-4 h-4"}),"Chamado Finalizado"]}):e.jsxs(e.Fragment,{children:[e.jsx(O,{className:"w-4 h-4"}),"Revisar"]}):e.jsxs(e.Fragment,{children:[e.jsx(T,{className:"w-4 h-4"}),"Finalizar Chamado"]})})})]})]}),e.jsx("div",{className:"w-full lg:w-80 space-y-6",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-gray-200 p-5 space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-xs font-bold text-gray-500 uppercase flex items-center gap-1",children:[e.jsx(O,{className:"w-4 h-4"})," Tipo"]}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:s.tipo||"",onChange:async a=>{const t=a.target.value;if(window.confirm(`Deseja alterar o tipo para "${t}"?`))try{const r={autor:"Sistema",mensagem:`Tipo alterado para ${t} por ${x()}`,data:new Date().toISOString()};await p(u(d,"chamados",c),{tipo:t,tipoAlterado:!0,interacoes:g(r)}),i.success(`Tipo alterado para: ${t}`)}catch(r){console.error("Error updating type:",r),i.error("Erro ao alterar tipo.")}},disabled:j,className:`w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg appearance-none text-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none font-medium text-base ${j?"opacity-60 cursor-not-allowed bg-gray-100":"cursor-pointer hover:border-blue-300"}`,children:[e.jsx("option",{value:"Devolucao",children:"Devolução"}),e.jsx("option",{value:"Reembolso",children:"Reembolso"}),e.jsx("option",{value:"Fraude",children:"Fraude"}),e.jsx("option",{value:"Contatar MarketPlace",children:"Contatar MarketPlace"}),e.jsx("option",{value:"Contatar Cliente",children:"Contatar Cliente"}),e.jsx("option",{value:"Interno",children:"Interno"}),e.jsx("option",{value:"Defeito",children:"Defeito"}),e.jsx("option",{value:"Prejuizo",children:"Prejuízo"}),e.jsx("option",{value:"Atraso na entrega",children:"Atraso na entrega"}),e.jsx("option",{value:"Produto errado",children:"Produto errado"}),e.jsx("option",{value:"Faltou item",children:"Faltou item"}),e.jsx("option",{value:"Duvida tecnica",children:"Dúvida técnica"}),e.jsx("option",{value:"Cancelamento",children:"Cancelamento"})]}),j&&e.jsx(v,{className:"absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"})]}),j&&e.jsxs("p",{className:"text-xs text-orange-500 flex items-center gap-1",children:[e.jsx(v,{className:"w-3 h-3"})," Alteração única permitida."]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-400 uppercase font-bold",children:"Pedido"}),e.jsx("p",{className:"text-lg font-bold text-gray-800",children:s.pedido||"N/A"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-xs text-gray-400 uppercase font-bold",children:"Marketplace"}),e.jsx("p",{className:"text-sm font-medium text-gray-700",children:s.marketplace||"N/A"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-xs font-bold text-gray-500 uppercase flex items-center gap-1",children:[e.jsx(ce,{className:"w-4 h-4"})," Responsável"]}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:s.responsavel||"",onChange:Q,disabled:f,className:`w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg appearance-none text-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none font-medium ${f?"opacity-60 cursor-not-allowed bg-gray-100":"cursor-pointer hover:border-blue-300"}`,children:[e.jsx("option",{value:"",disabled:!0,children:"Selecionar..."}),w.map(a=>e.jsx("option",{value:a.nome,children:a.nome},a.id))]}),f&&e.jsx(v,{className:"absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"})]}),f&&e.jsxs("p",{className:"text-xs text-orange-500 flex items-center gap-1",children:[e.jsx(v,{className:"w-3 h-3"})," Alteração única permitida."]})]}),e.jsx("hr",{className:"border-gray-100"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-400 uppercase font-bold mb-1",children:"Aberto em"}),e.jsxs("div",{className:"flex items-center gap-2 text-gray-600 font-medium text-sm",children:[e.jsx(ie,{className:"w-4 h-4 text-gray-400"}),new Date(s.dataAbertura).toLocaleString("pt-BR")]})]}),s.anexos&&s.anexos.length>0&&e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-400 uppercase font-bold mb-2",children:"Anexos do Chamado"}),e.jsx("div",{className:"flex flex-col gap-2",children:s.anexos.map((a,t)=>e.jsx(L,{anexo:a,compact:!0},t))})]})]})]})})]}),U&&e.jsxs("div",{className:"fixed inset-0 z-50 bg-black/90 flex items-center justify-center p-4 backdrop-blur-sm",onClick:()=>S(null),children:[e.jsx("button",{className:"absolute top-4 right-4 text-white hover:text-gray-300 p-2",onClick:()=>S(null),children:e.jsx(M,{className:"w-8 h-8"})}),e.jsx("img",{src:U,alt:"Preview",className:"max-w-full max-h-[90vh] object-contain rounded-lg shadow-2xl",onClick:a=>a.stopPropagation()})]})]})}export{Se as default};
