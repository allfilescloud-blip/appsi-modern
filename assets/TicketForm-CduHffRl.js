import{n as B,u as O,h as _,r as n,j as e,d as f,a as u,g as q,l as E,k as b,Q as l,q as W,w as H,p as J,t as K,v as Q,x as X,y as G,z as Y}from"./index-CagITQnK.js";import{A as Z}from"./arrow-left-C5_Hi7la.js";import{A as V}from"./alert-triangle-DLd7Ng_k.js";import{U as ee}from"./upload-K-eQqWo7.js";import{F as A}from"./file-text-CSWt8a9Q.js";import{X as ae}from"./x-Cd0rxfxV.js";import{S as se}from"./save-D813b30C.js";import"./createLucideIcon-o0tCEqv0.js";function me(){const{id:x}=B(),h=!!x,i=O(),{userData:o}=_(),[y,j]=n.useState(!1),[v,N]=n.useState(!1),[c,w]=n.useState({pedido:"",tipo:"",marketplace:"",assunto:"",descricao:"",responsavel:(o==null?void 0:o.nome)||""}),[d,S]=n.useState([]),[g,D]=n.useState([]),[F,z]=n.useState([]),[M,k]=n.useState([]),[T,C]=n.useState([]);n.useEffect(()=>{(async()=>{try{const a=f(u,"sys_settings","general"),t=await q(a);if(t.exists()){const r=t.data();k(r.ticketTypes||[]),C(r.marketplaces||[])}else k(["Devolução","Reembolso","Fraude","Contatar MarketPlace","Contatar Cliente","Interno","Defeito","Prejuízo","Atraso na entrega","Produto errado","Faltou item","Dúvida técnica","Cancelamento"]),C(["Mercado Livre","Amazon","Interno","Shopee","Magalu"])}catch(a){console.error("Error fetching settings:",a)}})()},[]),n.useEffect(()=>{(async()=>{try{const t=(await E(b(u,"usuarios"))).docs.map(r=>({id:r.id,...r.data()}));z(t)}catch(a){console.error("Error fetching users:",a)}})()},[]),n.useEffect(()=>{h&&(async()=>{try{const a=f(u,"chamados",x),t=await q(a);if(t.exists()){const r=t.data();w(r),r.anexos&&D(r.anexos)}else l.error("Chamado não encontrado"),i("/chamados")}catch(a){console.error("Erro ao buscar chamado:",a),l.error("Erro ao carregar dados do chamado")}})()},[x,h,i]);const m=s=>{const{name:a,value:t}=s.target;w(r=>({...r,[a]:t})),a==="pedido"&&R(t)},R=async s=>{if(!s||h)return;const a=W(b(u,"chamados"),H("pedido","==",s));try{(await E(a)).empty?N(!1):N(!0)}catch(t){console.error("Error checking for duplicate:",t)}},$=s=>{const a=Array.from(s.target.files);let t=d.reduce((r,p)=>r+p.size,0);for(const r of a)t+=r.size;if(t>5*1024*1024){l.error("O tamanho total dos arquivos não pode exceder 5MB");return}if(d.length+a.length>3){l.error("Máximo de 3 arquivos permitidos");return}S(r=>[...r,...a])},U=s=>{S(a=>a.filter((t,r)=>r!==s))},P=async()=>{const s=Date.now().toString().slice(-4),a=Math.floor(Math.random()*1e3).toString().padStart(3,"0");return`CH${s}${a}`},I=async s=>{s.preventDefault(),j(!0);try{let a=[...g];if(d.length>0)for(const t of d){const r=J(K,`chamados/${Date.now()}_${t.name}`),p=await Q(r,t),L=await X(p.ref);a.push({nome:t.name,url:L,tamanho:t.size,tipo:t.type})}if(h)await G(f(u,"chamados",x),{...c,anexos:a,dataAtualizacao:new Date().toISOString()}),l.success("Chamado atualizado com sucesso!"),i(`/chamados/${x}`);else{const t=await P(),r=await Y(b(u,"chamados"),{...c,codigo:t,anexos:a,status:"Aberto",dataAbertura:new Date().toISOString(),criadoPor:(o==null?void 0:o.email)||"Sistema",interacoes:[{autor:"Sistema",mensagem:`Chamado criado por ${(o==null?void 0:o.nome)||(o==null?void 0:o.email)||"Usuário"}`,data:new Date().toISOString()}]});l.success("Chamado criado com sucesso!"),i(`/chamados/${r.id}`)}}catch(a){console.error("Erro ao salvar chamado:",a),l.error("Erro ao salvar chamado.")}finally{j(!1)}};return e.jsxs("div",{className:"max-w-4xl mx-auto space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("button",{onClick:()=>i("/chamados"),className:"p-2 hover:bg-gray-100 rounded-full transition-colors",children:e.jsx(Z,{className:"w-6 h-6 text-gray-600"})}),e.jsx("h1",{className:"text-2xl font-bold text-gray-800",children:h?"Editar Chamado":"Novo Chamado"})]}),e.jsx("div",{className:"bg-white rounded-xl shadow-sm border border-gray-200 p-6",children:e.jsxs("form",{onSubmit:I,className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Número do Pedido"}),e.jsx("input",{type:"text",name:"pedido",required:!0,value:c.pedido,onChange:m,className:`w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none ${v?"border-orange-500 bg-orange-50":"border-gray-300"}`,placeholder:"Ex: 123456"}),v&&e.jsxs("p",{className:"text-xs text-orange-600 mt-1 flex items-center gap-1 font-medium",children:[e.jsx(V,{className:"w-3 h-3"}),"Já existe um chamado aberto para este pedido."]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Responsável"}),e.jsxs("select",{name:"responsavel",value:c.responsavel,onChange:m,className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white",children:[e.jsx("option",{value:"",children:"Selecione..."}),F.map(s=>e.jsx("option",{value:s.nome,children:s.nome},s.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Tipo de Chamado"}),e.jsxs("select",{name:"tipo",required:!0,value:c.tipo,onChange:m,className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none",children:[e.jsx("option",{value:"",children:"Selecione..."}),M.map(s=>e.jsx("option",{value:s,children:s},s))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Marketplace"}),e.jsxs("select",{name:"marketplace",value:c.marketplace,onChange:m,className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none",children:[e.jsx("option",{value:"",children:"Selecione..."}),T.map(s=>e.jsx("option",{value:s,children:s},s))]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Assunto"}),e.jsx("input",{type:"text",name:"assunto",required:!0,value:c.assunto,onChange:m,className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none",placeholder:"Resumo do problema"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Descrição"}),e.jsx("textarea",{name:"descricao",required:!0,rows:4,value:c.descricao,onChange:m,className:"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none resize-y",placeholder:"Detalhes completos do chamado..."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Anexos"}),e.jsxs("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-6 flex flex-col items-center justify-center bg-gray-50 hover:bg-gray-100 transition-colors cursor-pointer relative",children:[e.jsx("input",{type:"file",multiple:!0,onChange:$,className:"absolute inset-0 w-full h-full opacity-0 cursor-pointer"}),e.jsx(ee,{className:"w-8 h-8 text-gray-400 mb-2"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Clique ou arraste arquivos aqui"}),e.jsx("p",{className:"text-xs text-gray-400 mt-1",children:"Máx. 3 arquivos (5MB total)"})]}),(d.length>0||g.length>0)&&e.jsxs("div",{className:"mt-4 space-y-2",children:[g.map((s,a)=>e.jsx("div",{className:"flex items-center justify-between p-3 bg-blue-50 rounded-lg border border-blue-100",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(A,{className:"w-5 h-5 text-blue-600"}),e.jsx("span",{className:"text-sm text-blue-900 truncate",children:s.nome}),e.jsx("span",{className:"text-xs text-blue-500",children:"(Existente)"})]})},`existing-${a}`)),d.map((s,a)=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(A,{className:"w-5 h-5 text-gray-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-700 truncate",children:s.name}),e.jsxs("p",{className:"text-xs text-gray-500",children:[(s.size/1024).toFixed(1)," KB"]})]})]}),e.jsx("button",{type:"button",onClick:()=>U(a),className:"text-gray-400 hover:text-red-500 p-1",children:e.jsx(ae,{className:"w-5 h-5"})})]},a))]})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t border-gray-100",children:[e.jsx("button",{type:"button",onClick:()=>i("/chamados"),className:"px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition-colors",children:"Cancelar"}),e.jsx("button",{type:"submit",disabled:y,className:"px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg shadow-sm flex items-center gap-2 transition-all disabled:opacity-70 disabled:cursor-not-allowed",children:y?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"Salvando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(se,{className:"w-5 h-5"}),"Salvar"]})})]})]})})]})}export{me as default};
